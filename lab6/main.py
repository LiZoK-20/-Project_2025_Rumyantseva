from fastapi import FastAPI, Request, Form #–∏–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏
from fastapi.responses import HTMLResponse #–∏–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ html-–æ—Ç–≤–µ—Ç–æ–≤
from fastapi.templating import Jinja2Templates #–≤—Å—Ç–∞–≤–ª—è–µ—Ç Python-–∫–æ–¥ –≤ HTML
from fastapi.staticfiles import StaticFiles #–∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è css
from app.model import predict_iris, load_iris_model #–∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ model.py

#—Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
app = FastAPI(title='Iris Classifier')
#–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–ø–∫–∏ —Å html-—à–∞–±–ª–æ–Ω–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
templates = Jinja2Templates(directory='app/templates')
#–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–ø–∫–∏ —Å–æ —Å—Ç–∏–ª—è–º–∏
app.mount('/static', StaticFiles(directory='app/static'), name='static')

#–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä - —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
@app.on_event('startup') 
async def startup_event(): #–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    load_iris_model() #–≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ model.py

#–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä - —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç get-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
@app.get('/')
async def home(request: Request): #–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    return templates.TemplateResponse(  #–≤–æ–∑–≤—Ä–∞—Ç html-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞ index.html
        'index.html', 
        {'request': request, 'result': None} #–ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —à–∞–±–ª–æ–Ω: –∑–∞–ø—Ä–æ—Å –∏ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    )

#–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä - —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç post-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∞–¥—Ä–µ—Å /predict
@app.post('/predict') 
async def predict( #–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–æ—Ä–º—ã
    request: Request,  #–æ–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞
    sepal_length: float = Form(...),    #–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ —á–∏—Å–ª–æ
    sepal_width: float = Form(...),   
    petal_length: float = Form(...),  
    petal_width: float = Form(...)   
):
    #–≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏–∑ model.py —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    species = predict_iris(sepal_length, sepal_width, petal_length, petal_width)
    #–≤–æ–∑–≤—Ä–∞—Ç html-—Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    return templates.TemplateResponse(
        'index.html',
        {
            'request': request, #–ø–µ—Ä–µ–¥–∞—á–∞ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ —à–∞–±–ª–æ–Ω
            'result': f'üå∏ –í–∏–¥ –∏—Ä–∏—Å–∞: {species}', #—Å—Ç—Ä–æ–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
             #–ø–µ—Ä–µ–¥–∞—á–∞ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–æ—Ä–º—É (—á—Ç–æ–±—ã –Ω–µ –∏—Å—á–µ–∑–∞–ª–∏)
            'sepal_length': sepal_length, 
            'sepal_width': sepal_width,
            'petal_length': petal_length,
            'petal_width': petal_width
        }
    )